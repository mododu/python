(function(){
var domain = "";
var start = 0;
var tags = {};
var types = ["text", "photo", "link", "video", "audio"];
var typesCN=["文字", "照片", "链接", "视频", "音乐"]; 
var vidLength, $posts, flashCount, photoSetLength, sortedTags, newPosts;
var firstLoad = true;
var emptyNav = false;
var firstPhoto = true;
function isotopeShitUp() {
	firstLoad = false;
	$("#posts .post").find("img").imagesLoaded(function() {
		$posts.isotope({
			itemSelector : ".post"
			/*,
			animationEngine : (!$(html).hasClass('ie9')&&$.client.browser==='Explorer')?'jquery':'best-available'
			*/
		});
		$posts.css({
			opacity : 0,
			visibility : "visible"
		}).animate({
			opacity : 1
		});
		$("#initialLoader").fadeOut();
		if(!emptyNav) {
			$(".more").show()
		}
	})
}

function addIsotopeShit(a) {
	$(a).find("img").imagesLoaded(function() {
		$posts.isotope("insert", $(a));
		$(a).css({
			opacity : 0,
			visibility : "visible"
		}).animate({
			opacity : 1
		});
		$("#infscr-loading").fadeOut()
	})
}
function postEvergreening() {
	$("#posts .post:not(.video, .photoset) iframe, #posts .post:not(.video, .photoset) object").each(function() {
		var a = $(this).parents(".postInner").find(".permaLink a").attr("href");
		$(this).replaceWith('<a class="flash-content" href="' + a + '">Watch</a>')
	});
	$(".video, .audio, .photo, .photoset").each(function() {
		var a = $(this).find(".caption").length;
		if(a === 0) {
			$(this).addClass("noCaption")
		}
	});
	$(".audio").each(function() {
		if($(this).find("a.albumArt").length === 0) {
			$(this).find(".audioListen").show()
		}
	})
}


function sortTags(a, b) {
	return a.sort(function(d, c) {
		return b[d] - b[c]
	})
}

function getProps(c) {
	var a = [];
	var b;
	for(b in c) {
		if(c.hasOwnProperty(b)) {
			a.push(b)
		}
	}
	return a
}

function convertToSlug(a) {
	return a.toLowerCase().replace(/ /g, "_").replace(/[^\w-]+/g, "")
}

function hasTag(post,tag) {
	var hastag = false;
	$(post).each(function(index,item){
  		$($(item).data("tags").split(',')).each(function(inx,it){
  			if(it == tag){
  				hastag = true;
  				return false;
  			}
  		});
 	});
  	return hastag;
}
//字符串截断
function truncate(str,len){
	return str.length>len?str.slice(0,len)+'...':str;
}
function listTags() {
	$(".filters.tag").empty();
	$(".filters.tag").append('<li><a data-filter="*" class="active all-type">所有</a></li>');
	$(allTags).each(function(a, b) {
		if(hasTag('#posts .post',b)){
			$(".filters.tag").append('<li><a data-filter="' + b + '">' + truncate(b,10) + "</a></li>");
		}
	});
}

function listTypes() {
	$(".filters.type").empty();
	$(".filters.type").append('<li><a data-filter="*" class="active all-type">所有</a></li>');
	$(types).each(function(a, b) {
		if($("#posts .post").hasClass(b)) {
			$(".filters.type").append('<li><a data-filter=".' + b + '">' + typesCN[a] + "</a></li>")
		}
	});
}
$(function() {
	$(window).scroll(function() {
		var b = $(window).scrollTop();
		if(b > 200) {
			$("#backtotop").fadeIn("slow")
		}
		if(b < 200) {
			$("#backtotop").fadeOut("slow")
		}
	});
	$("#backtotop").hover(function() {
		$(this).addClass("hover")
	}, function() {
		$(this).removeClass("hover")
	});
	$(".meta div ").hover(function() {
		$(this).addClass("hover")
	}, function() {
		$(this).removeClass("hover")
	});
	$("#backtotop").click(function() {
		$.scrollTo(0, {
			duration : 700,
			axis : "y"
		})
	});
	postEvergreening();
	if($.client.browser === "Chrome") {
		$("body").addClass("chrome")
	}
	var nextPages = $(".navigation a").length;
	if(nextPages <= 0) {
		emptyNav = true;
	}
	$posts = $("#posts");
	isotopeShitUp()
	$posts.infinitescroll({
		navSelector : ".navigation",
		nextSelector : ".navigation .nextPage",
		itemSelector : ".post",
		loadingText : "",
		loadingImg : "http://o.srcdd.com/id_34/img/loading.gif",
		loadingMsg : "Loading",
		animate : true,
		debug : false,
		errorCallback : function() {
			$("#infscr-loading").fadeOut();
			$(".more").show();
			$(".more").html("没有更多文章").animate({
				opacity : 0.8
			}, 2000).fadeOut("normal")
		}
	}, function(b) {
		firstPhoto = true;
		listTags();
		listTypes();
		postEvergreening();
		$(b).css("visibility", "hidden");
		addIsotopeShit(b);
	});
	$posts.infinitescroll("binding", "unbind");
	$(".more").click(function(b) {
		$(".resetNote").hide();
		if($(".all-tag").hasClass("active") || $(".all-type").hasClass("active")) {
			$posts.infinitescroll("retrieve");
			$(this).css("display", "block")
		} else {
			$("#posts").isotope({
				filter : "*"
			});
			$(".filter li a").removeClass("active");
			$(".all-type").addClass("active");
			$.scrollTo($(document).height(), {
				duration : 700,
				axis : "y",
				onAfter : function() {
					$posts.infinitescroll("retrieve");
					$(this).css("display", "block")
				}
			})
		}
	});
	$(".more").hover(function() {
		if($(".all-tag").hasClass("active") || $(".all-type").hasClass("active")) {
		} else {
			$(".resetNote").show()
		}
	}, function() {
		$(".resetNote").hide()
	});
	$(document).ajaxError(function(c, d, b) {
		if(d.status == 404) {
			$(".more").remove()
		}
	});
	$(".filter a").live("click", function() {
		var filterSeletor,$this=$(this),
		fitlerElemtents=[];
		$(".filter a").removeClass("active");
		$this.addClass("active");
		var b = $this.attr("data-filter");
		if($this.parent().parent().hasClass('tag')){
			$("#posts .post").each(function(index,item){
				var $item=$(item);
				var tags = $item.data("tags").split(',');
				$(tags).each(function(inx,it){
					if(it == b){
						fitlerElemtents.push('#'+$item.attr('id'));
					}
				});
			});
			filterSeletor = fitlerElemtents.join(",")
		}
		else{
			filterSeletor=b;
		}
		$("#posts").isotope({
			filter : filterSeletor
		});
		return false
	});
	domain = window.location.protocol + "//" + window.location.hostname;
	listTypes();
	listTags();
});
})(jQuery)
